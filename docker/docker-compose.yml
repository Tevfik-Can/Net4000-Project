version: '3.8'

services:
  # HTTP Server
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
    container_name: observability-server
    ports:
      - "8080:8080"
    networks:
      - observability-net
    volumes:
      - ./results:/output
    command: python3 src/application/server.py --host 0.0.0.0 --port 8080
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # eBPF Monitor (requires privileged mode)
  ebpf-monitor:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ebpf
    container_name: observability-ebpf
    privileged: true
    network_mode: host
    pid: host
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /lib/modules:/lib/modules:ro
      - /usr/src:/usr/src:ro
      - ./results:/output
    depends_on:
      server:
        condition: service_healthy
    command: >
      bash -c "
      sleep 5 &&
      python3 src/ebpf/runner.py 
        --output /output/ebpf_events.json
      "

  # HTTP Client (Load Generator)
  client:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
    container_name: observability-client
    networks:
      - observability-net
    volumes:
      - ./results:/output
    depends_on:
      server:
        condition: service_healthy
    command: >
      bash -c "
      sleep 10 &&
      python3 src/application/client.py 
        --url http://server:8080 
        --requests 50
        --interval 200
        --output /output/client_metrics.json
      "

  # Correlation Analysis (runs after data collection)
  correlator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
    container_name: observability-correlator
    volumes:
      - ./results:/output
    depends_on:
      - client
      - ebpf-monitor
    command: >
      bash -c "
      sleep 20 &&
      python3 src/correlation/correlator.py
        --app-metrics /output/client_metrics.json
        --ebpf-events /output/ebpf_events.json
        --output /output/correlations.json
      "

networks:
  observability-net:
    driver: bridge

volumes:
  results:
    driver: local

# Usage:
# 1. Build images:
#    docker-compose build
#
# 2. Run the stack:
#    docker-compose up
#
# 3. View logs:
#    docker-compose logs -f
#
# 4. Stop and clean up:
#    docker-compose down
#
# 5. Results will be in ./results/

# Note: eBPF monitoring requires host network mode and privileged access
# to properly monitor kernel TCP events
